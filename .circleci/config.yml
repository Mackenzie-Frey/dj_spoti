version: 2
jobs:
  build:
    ...
  deploy:
    # docker:
    #   - image: buildpack-deps:trusty
    
    # steps:
    #   - checkout
      steps:
        # Run rspec in parallel
        - run: |
            bundle exec rspec --profile 10 \
                              --format RspecJunitFormatter \
                              --out test_results/rspec.xml \
                              --format progress \
                              $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)

        # Save test results for timing analysis
        - store_test_results:
            path: test_results

        # Deploy to heroku
      - run:
          name: Deploy Master to Heroku
          command: |
            git push https://heroku:$ENV['HEROKU_SECRET_KEY']@git.heroku.com/$dj-spoti.git master

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
